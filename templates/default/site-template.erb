# Generated by Chef for <%= node['fqdn'] %>
# Do NOT modify this file by hand.
#
<% unless nil_or_empty?(@upstream) -%>

# Upstream
<% @upstream.each do |name, hash| -%>
upstream <%= name %> {
  <% Array(hash.fetch('server')).each do |serv| -%>
  server <%= serv %>;
  <% end -%>
  <% unless nil_or_empty?(hash.dig('options')) -%>

  <% Array(hash.fetch('options')).each do |option| -%>
  <%= option %>;
  <% end -%>
  <% end -%>
}
<% end -%>
<% end -%>
<% unless nil_or_empty?(@server) -%>

# Server
# <%= @name %>
server {
  <% Array(@server.fetch('listen')).each do |listener| %>
  listen <%= listener %>;
  <% end %>

  server_name <%= Array(@server.fetch('server_name')).join(' ') %>;
  <% if nil_or_empty?(@server.dig('extra_options', 'root')) -%>
  root /usr/share/nginx/html;
  <% end -%>
  <% unless nil_or_empty?(@server.dig('ssl')) -%>

  <% @server['ssl'].each do |key, value| -%>
  <%= key %> <%= value %>;
  <% end -%>
  <% end -%>
  <% unless nil_or_empty?(@server.dig('includes')) -%>

  <% Array(@server['includes']).each do |include| -%>
  include <%= include %>;
  <% end -%>
  <% end -%>
  <% unless nil_or_empty?(@server.dig('extra_options')) -%>

  <% @server['extra_options'].each do |key, value| -%>
  <% Array(value).each do |val| -%>
  <%= key %> <%= val %>;
  <% end -%>
  <% end -%>
  <% end -%>
  <% unless nil_or_empty?(@server.dig('locations')) -%>

  <% @server['locations'].each do |location, options| -%>
  location <%= location %> {
    <% unless nil_or_empty?(options) -%>
    <% options.each do |option, value| -%>
    <% if nil_or_empty?(value) -%>
    <%= option %>;
    <% else -%>
    <% Array(value).each do |val| -%>
    <%= option %> <%= val %><% unless String(val).end_with?('}') -%>;<% end -%>
    <% end -%>
    <% end -%>
    <% end -%>
    <% end -%>
  }
  <% end -%>
  <% end -%>

  <% if nil_or_empty?(@server.dig('access_log')) -%>
  access_log /var/log/nginx/site-<%= @server.fetch('server_name').first %>-access.log;
  <% else -%>
  access_log <%= @server['access_log'] %>;
  <% end -%>
  <% if nil_or_empty?(@server.dig('error_log')) -%>
  error_log /var/log/nginx/site-<%= @server.fetch('server_name').first %>-error.log;
  <% else -%>
  error_log <%= @server['error_log'] %>;
  <% end -%>
}
<% end -%>
<% unless nil_or_empty?(@map) -%>

# Map
<% @map.each do |name, hostnames| -%>
map <%= name %> {
<% hostnames.each do |hostname, option| -%>
  <%= hostname %> <%= option %>;
<% end -%>
}
<% end -%>
<% end -%>
<% unless nil_or_empty?(@options) -%>

# Options
<% @options.each do |option, value| -%>
<%= option %> <%= value %>;
<% end -%>
<% end -%>
